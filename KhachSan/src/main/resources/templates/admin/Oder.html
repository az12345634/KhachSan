<!DOCTYPE html>
<html lang="en">
<div th:replace="admin/fragments/head :: head"></div>

<body>
<!-- ======= Header ======= -->
<div th:replace="admin/fragments/header :: header"></div>

<!-- ======= Sidebar ======= -->
<div th:replace="admin/fragments/aside :: aside"></div>

<main id="main" class="main">
<!--Chứa table -->
    <div class="pagetitle">
        <h1>Data Order</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/admin}" href="index.html">Trang Chủ</a></li>
                <li class="breadcrumb-item">Tables</li>
                <li class="breadcrumb-item active">Data</li>
            </ol>
        </nav>
    </div><!-- End Page Title -->
    <section class="section">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">

                        <div class="search">
                            <h5 class="card-title">Danh sách hoá đơn phòng <span type="button" class="badge bg-warning" style="float: right;color:#ffffff">Thêm mới</span ></h5></div>

<!--                         Table thông tin muốn hiển thị -->
                        <table class="table table-bordered" id="tableDate">
                            <thead>
                            <tr >
                                <th scope="col">STT</th>
                                <th scope="col">Mã đơn hàng</th>
                                <th scope="col">Khách hàng </th>
                                <th scope="col">Tên sản phẩm  </th>
                                <th scope="col">Tổng giá</th>
                                <th scope="col">Số điện thoại</th>
                                <th scope="col">Ngày Thanh toán</th>
                                <th scope="col" class="datatable-sorter">Thanh toán</th>

                            </tr>
                            </thead>
                            <tbody >
                            </tbody>
                        </table>
                        <nav aria-label="Page navigation example">
                            <ul style="justify-content: center" id="pag" class="pagination">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </section>

</main><!-- End #main -->
<div th:replace="admin/fragments/footer :: footer"></div>
<a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>
<div th:replace="admin/fragments/script :: script"></div>
 <script>
     $(document).ready(function (){
         initData();
     })
// gọi tới hàm load và phân trang
     function initData(){
         let page=0;
         let size=5;
         let objFilter = {
             name:null
         };
         getOderAdmin(page,size,objFilter);
     }
     function formatPrice(price) {
         return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price);
     }
     function getOderAdmin(page,size,objectFilter){
         $.ajax({
             type: "POST",
             url: "http://localhost:8080/api/order?page=" + page + "&size=" + size,
             contentType: "application/json",
             data: JSON.stringify(objectFilter),
             dataType: "json",
             success: function (response) {
                 let dataOder = response?.data?.content;
                let OderO = ''
                 for (let i = 0; i < dataOder.length; i++) {
                     let formattedOrder = formatPrice(dataOder[i].totalAmount);
                     console.log(dataOder[i]);
                     let status = dataOder[i].status === 1 ? "Chưa thanh toán" : "Đã thanh toán";
                     let classStatus = dataOder[i].status === 1 ? "danger" : "success";
                     OderO += '<tr>' +
                         '<td data-id="' + dataOder[i].id + '">' + (i + 1) + '</td>' +
                         '<td data-code="' + dataOder[i].code + '">' + dataOder[i].code + '</td>'+
                         '<td data-code="' + dataOder[i].username + '">' + dataOder[i].username + '</td>'+
                         '<td data-code="' + dataOder[i].productname + '">' + dataOder[i].productname + '</td>'+
                         '<td data-totalAmount="' + dataOder[i].totalAmount + '">'+ formattedOrder + '</td>' +
                         '<td data-phoneShipping="' + dataOder[i].phoneShipping + '">' + dataOder[i].phoneShipping + '</td>' +
                         '<td data-createDate="' + dataOder[i].createDate + '">' + dataOder[i].createDate + '</td>' +
                         '<td><span style="color:white; border-radius: 20px; margin-left: 5%; margin-top: 6%; line-height: 1" class="badge bg-' + classStatus + '">' + status + '</span> </td>' +

                         '</tr>';
                 }
                 $('#tableDate tbody').empty(); //  jQuery được sử dụng để xóa tất cả các phần tử có id là tableDate để ko lặp trang.
                 $('#tableDate').append(OderO);// lấy danh sách gán vào view

                 // Phân trang
                 let totalPage = response.data.totalPages;
                 let currentPage = response.data.pageable.pageNumber;
                 console.log(totalPage, currentPage);

                 if (totalPage > 0) {
                     let pages = '<li class="page-item">';
                     if (currentPage - 1 < 0) {
                         pages = '<li class="page-item">';
                     }
                     pages +=
                         '<a class="page-link" href="#" onclick="changePage(' + (currentPage - 1) + ',' + size + ')" aria-label="<">' +
                         '<span aria-hidden="true"> < </span>' +
                         '</a>' +
                         '</li>';

                     for (let i = 0; i < totalPage; i++) {
                         if (currentPage === i) {
                             pages += '<li class="page-item"><a onclick="changePage(' + i + ',' + size + ')" class="page-link" href="#">' + (i + 1) + '</a></li>';
                         } else pages += '<li class="page-item"><a onclick="changePage(' + i + ',' + size + ')" class="page-link" href="#">' + (i + 1) + '</a></li>';
                     }

                     if (currentPage + 1 > totalPage - 1) {
                         pages += '<li class="page-item">'
                     } else {
                         pages += '<li class="page-item">'
                     }
                     pages +=
                         '<a class="page-link" href="#" onclick="changePage(' + (currentPage + 1) + ',' + size + ')" aria-label=">">' +
                         '<span aria-hidden="true"> > </i></span>' +
                         '</a>' +
                         '</li>'

                     $('#pag').html(pages);
                 }
             },
             error: function (error) {
                 console.log(error);
             }
         });
     };
     // hàm xử lý sự kiện
     function changePage(page, size) {
         let filter = {};
         $.ajax({
             type: "POST",
             url: HOST + "/api/order?page=" + page + "&size=" + size,
             contentType: "application/json",
             data: JSON.stringify(filter),
             dataType: "json",
             success: function (response) {
                 if (response.data.content.length === 0) {
                     // Nếu không có sản phẩm, thông báo và không chuyển trang
                     Swal.fire({
                         title: "Thông báo",
                         text: "Không có sản phẩm nào ở trang này!",
                         icon: "info",
                     });
                     return;
                 }
                 // Nếu có sản phẩm, hiển thị sản phẩm và cập nhật phân trang
                 getOderAdmin(page, size, filter);
             },
             error: function (error) {
                 console.error("Lỗi khi chuyển trang:", error);
             }
         });
     }
 </script>
</body>

</html>