<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="admin/fragments/head :: head"></head>
<body>
<!-- ======= Header ======= -->
<head th:replace="admin/fragments/header :: header"></head>
<!-- ======= Sidebar ======= -->
<aside th:replace="admin/fragments/aside :: aside"></aside>
<main id="main" class="main">
    <div class="pagetitle">
        <h1>Thống Kê</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/admin}" href="index.html">Trang Chủ</a></li>
                <li class="breadcrumb-item active">Thống Kê</li>
            </ol>
        </nav>
    </div><!-- End Page Title -->

    <section class="section dashboard">
        <div class="row">

            <!-- Left side columns -->
            <div class="col-lg-8">
                <div class="row">

                    <!-- Sales Card -->
                    <div class="col-xxl-4 col-md-6">
                        <div class="card info-card sales-card">
                            <div class="card-body">
                                <h5 class="card-title">Đơn hàng </h5>

                                <div class="d-flex align-items-center">
                                    <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                        <i class="bi bi-cart"></i>
                                    </div>
                                    <div class="ps-3">
                                        <h6 id="donhang">145</h6>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div><!-- End Sales Card -->

                    <!-- Revenue Card -->
                    <div class="col-xxl-4 col-md-6">
                        <div class="card info-card revenue-card">
                            <div class="card-body">
                                <h5 class="card-title">Doanh Thu</h5>

                                <div class="d-flex align-items-center">
                                    <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                        <i class="bi bi-currency-dollar"></i>
                                    </div>
                                    <div class="ps-3">
                                        <h6 id="doanhthu">$3,264</h6>


                                    </div>
                                </div>
                            </div>

                        </div>
                    </div><!-- End Revenue Card -->

                    <!-- Customers Card -->
                    <div class="col-xxl-4 col-xl-12">

                        <div class="card info-card customers-card">
                            <div class="card-body">
                                <h5 class="card-title">Khách Hàng <span>| Năm Nay</span></h5>

                                <div class="d-flex align-items-center">
                                    <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                        <i class="bi bi-people"></i>
                                    </div>
                                    <div class="ps-3">
                                        <h6 id="totalCustomers">1244</h6>
<!--                                        <span id="customerChange" class="text-danger small pt-1 fw-bold">12%</span> <span-->
<!--                                            class="text-muted small pt-2 ps-1">giảm</span>-->

                                    </div>
                                </div>

                            </div>
                        </div>

                    </div><!-- End Customers Card -->


                    <!-- Recent Sales -->
                    <div class="col-12">
                        <div class="card recent-sales overflow-auto">
                            <div class="card-body">
                                <h5 class="card-title">Đơn Hàng Gần Đây <span>| Hôm Nay</span></h5>

                                <div class="datatable-wrapper datatable-loading no-footer sortable searchable fixed-columns">
                                    <div class="datatable-top">
                                        <div class="datatable-dropdown">
                                            <label>
                                                <select name="filterOrder" id="pageLoadOrder"></select> Mục trang
                                            </label>
                                        </div>

                                        <div class="search">
                                                <input style="border-color: antiquewhite;" type="text" id="code" placeholder="Search" >
                                                <button style="position: absolute;margin-left: -31px;background-color: white;
                                                padding: 0;margin-top: 3px;border: none;" id="btnSearch" onclick="searchCondition(0,5)" ><i class="bi bi-search"></i></button>
                                        </div>


                                    </div>
                                    <div class="datatable-container">
                                        <table class="table table-borderless datatable datatable-table">
                                            <thead>
                                            <tr>
                                                <th style="width: 20.096385542168676%;">
                                                    <button class="datatable-sorter">Mã đơn hàng</button>
                                                </th>
                                                <th style="width: 16.819277108433734%;">
                                                    <button class="datatable-sorter">Tổng giá</button>
                                                </th>

                                                <th style="width: 16.14457831325301%;">
                                                    <button class="datatable-sorter">Số điện thoại</button>
                                                </th>
                                                <th data-sortable="true" style="width: 20.240963855421686%;">
                                                    <button class="datatable-sorter">Thanh toán</button>
                                                </th>
                                            </tr>
                                            </thead>
                                            <tbody id="tableDate"></tbody>

                                        </table>
                                    </div>
<!--                                    <div class="apexcharts-legend apexcharts-align-center apx-legend-position-bottom" xmlns="http://www.w3.org/1999/xhtml" style="inset: auto 0px 1px; position: absolute; max-height: 175px;">-->
<!--                                        <div class="apexcharts-legend-series" rel="1" seriesname="BánxHàng" style="margin: 2px 5px;"><span class="apexcharts-legend-marker" rel="1"  style="background: rgb(255 9 9) !important; color: rgb(65, 84, 241); height: 12px; width: 12px; left: 0px; top: 0px; border-width: 0px; border-color: rgb(255, 255, 255); border-radius: 12px;"></span><span class="apexcharts-legend-text" rel="1" i="0"  style="color: rgb(55, 61, 63); font-size: 12px; font-weight: 400; font-family: Helvetica, Arial, sans-serif;">Chưa Thanh Toán</span></div>-->
<!--                                        <div class="apexcharts-legend-series" rel="2" seriesname="DoanhxThu"  style="margin: 2px 5px;"><span class="apexcharts-legend-marker" rel="2"  style="background: rgb(46, 202, 106) !important; color: rgb(46, 202, 106); height: 12px; width: 12px; left: 0px; top: 0px; border-width: 0px; border-color: rgb(255, 255, 255); border-radius: 12px;"></span><span class="apexcharts-legend-text" rel="2" i="1"  style="color: rgb(55, 61, 63); font-size: 12px; font-weight: 400; font-family: Helvetica, Arial, sans-serif;">Đã Thanh Toán</span></div>-->
<!--                                        <div class="apexcharts-legend-series" rel="3" seriesname="KháchxHàng"  style="margin: 2px 5px;"><span class="apexcharts-legend-marker" rel="3"  style="background: rgb(230 223 21) !important; color: rgb(255, 119, 29); height: 12px; width: 12px; left: 0px; top: 0px; border-width: 0px; border-color: rgb(255, 255, 255); border-radius: 12px;"></span><span class="apexcharts-legend-text" rel="3" i="2"  style="color: rgb(55, 61, 63); font-size: 12px; font-weight: 400; font-family: Helvetica, Arial, sans-serif;">Đơn Hàng Hủy</span></div>-->
<!--                                    </div>-->
                                </div>

                            </div>

                        </div>
                    </div><!-- End Recent Sales -->
                </div>
            </div><!-- End Left side columns -->


        </div>


    </section>

</main><!-- End #main -->

<!-- ======= Footer ======= -->
<footer th:replace="admin/fragments/footer :: footer"></footer>

<a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
        class="bi bi-arrow-up-short"></i></a>

<div th:replace="admin/fragments/script :: script"></div>


</body>
<script>
    $(document).ready(function () {
        initData();
    });

    // gọi tới hàm load và phân trang
    function initData() {
        let page = 0;
        let size = 5;
        let objFilter = {
            name: null
        };
        getOderAdminIndex(page, size, objFilter);
        listOption();
    }

    function getOderAdminIndex(page, size, objectFilter) {
        $.ajax({
            type: "POST",
            url: "http://localhost:8080/api/order?page=" + page + "&size=" + size,
            contentType: "application/json",
            data: JSON.stringify(objectFilter),
            dataType: "json",
            success: function (response) {
                console.log(response);
                let dataOder = response?.data?.content;
                let OderO = '';
                for (let i = 0; i < dataOder.length; i++) {
                    let formattedOrder = dataOder[i].totalAmount.toLocaleString('vi-VN', {
                        style: 'currency',
                        currency: 'VND'
                    });

                    let status = dataOder[i].status === 1 ? "Chưa thanh toán" : "Đã thanh toán";
                    let classStatus = dataOder[i].status === 1 ? "danger" : "success";
                    OderO += '<tr>' +
                        '<td style="padding-left: 2%; padding-top: 2%; color: #4154f1;" data-code="' + dataOder[i].code + '">' + dataOder[i].code + '</td>' +
                        '<td style="padding-left: 2%; padding-top: 2%;" data-totalAmount="' + dataOder[i].totalAmount + '">' + formattedOrder + '</td>' +
                        '<td style="padding-left: 2%;padding-top: 2%;" data-phoneShipping="' + dataOder[i].phoneShipping + '">' + dataOder[i].phoneShipping + '</td>' +
                        '<td><span style="color:white; border-radius: 20px; margin-left: 5%; margin-top: 6%; line-height: 1" class="badge bg-' + classStatus + '">' + status + '</span> </td>' +
                        '</tr>';
                }

                $('#tableDate').html(OderO); // lấy danh sách gán vào view

                // Phân trang
                let totalPage = response.data.totalPages;
                if (totalPage > 0) {
                    let currentPage = response.data.pageable.pageNumber;

                    let pages = '';
                    for (let i = 0; i < totalPage; i++) {

                        pages += '<option value="' + i + '"';
                        if (i === currentPage) {
                            pages += ' selected';
                        }
                        pages += '>' + (i + 1) + '</option>';
                    }

                    $('#pageLoadOrder').html(pages);
                }
            },
            error: function (error) {
                console.log(error);
            }
        });
    }


    // hàm xử lý sự kiện
    function listOption() {
        $('#pageLoadOrder').change(function () {
            let page = $(this).val();
            let size = 5;
            getOderAdminIndex(page, size, {});
        })
    }
    function searchCondition(page,size){
        let filter = {};

        filter.code = $("#code").val() === '' ? null : $("#code").val();

        getOderAdminIndex(page,size,filter);
    }

    $(document).ready(function () {
        // Gọi tất cả API khi trang tải
        loadDashboardData();

        // Gọi API mỗi 10 giây
        setInterval(loadDashboardData, 100);
    });

    // Hàm gọi tất cả API
    function loadDashboardData() {
        fetchData("#totalCustomers", "http://localhost:8080/api/order/customers");
        fetchData("#doanhthu", "http://localhost:8080/api/order/revenue");
        fetchData("#donhang", "http://localhost:8080/api/order/successful-orders");
    }

    // Hàm fetch dữ liệu từ API
    function fetchData(elementId, apiUrl) {
        $.ajax({
            url: apiUrl,
            type: "GET",
            success: function (response) {
                if (response.code === 200) {
                    $(elementId).text(response.data.toLocaleString("vi-VN"));
                } else {
                    $(elementId).text("Không thể lấy dữ liệu");
                }
            },
            error: function () {
                $(elementId).text("Lỗi kết nối API");
            }
        });
    }


</script>

</html>